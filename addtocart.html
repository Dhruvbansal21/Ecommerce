<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shopping Cart</title>
  <link rel="stylesheet" href="responsive.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Poppins", sans-serif;
    }

    body {
      background:beige;
      color: #0f172a;
      padding: 40px;
    }

    h2 {
      text-align: center;
      margin-bottom: 30px;
      font-size: 26px;
    }

    .cart-container {
      max-width: 980px;
      margin: auto;
      background:antiquewhite;
      border-radius: 16px;
      box-shadow: 0 20px 50px rgba(15, 23, 42, 0.12);
      overflow: hidden;
      border: 1px solid #e5e7eb;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: linear-gradient(180deg, #f8fafc, #eef2ff);
    }

    thead th {
      text-align: left;
      padding: 16px;
      font-weight: 600;
      color: #374151;
      font-size: 15px;
    }

    tbody td {
      padding: 16px;
      border-bottom: 1px solid #eee;
      vertical-align: middle;
    }

    .product-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .product-info img {
      width: 70px;
      height: 70px;
      object-fit: cover;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.08);
      background: #fff;
    }

    .product-details {
      font-size: 14px;
      color: #444;
    }

    .product-details small {
      display: block;
      color: #888;
      margin-top: 4px;
    }

    .quantity-control {
      display: flex;
      align-items: center;
      gap: 12px;
      border: 1px solid #e5e7eb;
      border-radius: 9999px;
      padding: 6px 14px;
      width: fit-content;
      background: #f8fafc;
    }

    .quantity-control span {
      font-size: 14px;
      font-weight: 500;
    }

    .quantity-control button {
      border: none;
      background: #4f46e5;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
      padding: 6px 10px;
      border-radius: 9999px;
      transition: transform .08s ease, opacity .2s ease;
    }

    .quantity-control button:hover { opacity: .95; }
    .quantity-control button:active { transform: scale(.96); }

    .remove-btn {
      cursor: pointer;
      font-size: 18px;
      color: #ef4444;
    }

    .summary {
      display: flex;
      justify-content: space-between;
      padding: 20px;
      background: linear-gradient(180deg, #f8fafc, #eef2ff);
      border-top: 1px solid #e5e7eb;
      font-size: 16px;
    }

    .summary div {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .summary .left, .summary .right {
      width: 48%;
    }

    .promo {
      display: flex;
      margin-top: 20px;
      gap: 10px;
    }

    .promo input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }

    .promo button {
      padding: 10px 20px;
      border: none;
      background: rgb(235, 178, 103);
      color: #fff;
      font-weight: 500;
      border-radius: 6px;
      cursor: pointer;
    }

    .cart-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }

    .cart-actions button {
      flex: 1;
      padding: 14px;
      font-size: 16px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      border-radius: 10px;
      transition: transform .08s ease, opacity .2s ease;
    }

    .cart-actions button:hover { opacity: .95; }
    .cart-actions button:active { transform: scale(.98); }

    .back-btn {
      background: #32353d;
      color: #fff;
      margin-right: 10px;
    }

    .checkout-btn {
      background:rgb(235, 178, 103);
      color: #fff;
      margin-left: 10px;
    }
    
    /* Empty cart state */
    .cart-empty {
      padding: 40px;
      text-align: center;
      color: #6b7280;
      font-size: 16px;
    }

    /* Confirmation Modal Styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .confirmation-modal {
      background: white;
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .confirmation-modal h2 {
      color: #2d5016;
      margin-bottom: 15px;
      font-size: 24px;
    }

    .confirmation-modal p {
      color: #333;
      font-size: 16px;
      line-height: 1.5;
      margin-bottom: 25px;
    }

    .confirmation-modal .location-highlight {
      color: rgb(235, 178, 103);
      font-weight: bold;
    }

    .confirmation-modal button {
      background: rgb(235, 178, 103);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .confirmation-modal button:hover {
      background: rgb(220, 165, 90);
    }

    /* Dynamic cart list styles (for elements rendered by cart.js) */
    #cart-items {
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding: 16px 20px 6px;
    }

    .cart-row {
      display: grid;
      grid-template-columns: 80px 1fr 120px 180px 130px 90px;
      align-items: center;
      gap: 16px;
      background: antiquewhite;
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 14px 16px;
      box-shadow: 0 6px 20px rgba(15, 23, 42, 0.06);
    }

    .cart-item-image {
      width: 72px;
      height: 72px;
      object-fit: cover;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #fff;
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.08);
    }

    .cart-item-name {
      font-weight: 600;
      color: #111827;
      line-height: 1.3;
    }

    .cart-item-price,
    .cart-item-total {
      font-weight: 700;
      color: #111827;
    }

    .cart-item-qty {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      border: 1px solid #e5e7eb;
      border-radius: 9999px;
      padding: 6px 12px;
      background: #f8fafc;
      width: fit-content;
      white-space: nowrap;
    }

    .cart-item-qty .qty-value {
      min-width: 20px;
      text-align: center;
      font-weight: 600;
      color: #111827;
      display: inline-block;
      padding: 0 8px;
    }

    .cart-item-qty .qty-increase,
    .cart-item-qty .qty-decrease {
      border: none;
      background: rgb(235, 178, 103);
      color: #fff;
      font-size: 14px;
      cursor: pointer;
      padding: 6px 10px;
      border-radius: 9999px;
      transition: transform .08s ease, opacity .2s ease;
    }

    .cart-item-qty .qty-decrease { background:#6b7280; }
    .cart-item-qty .qty-increase:hover,
    .cart-item-qty .qty-decrease:hover { opacity: .95; }
    .cart-item-qty .qty-increase:active,
    .cart-item-qty .qty-decrease:active { transform: scale(.96); }

    .cart-item-remove {
      background: transparent;
      border: 1px solid #fecaca;
      color: #ef4444;
      padding: 8px 10px;
      border-radius: 10px;
      cursor: pointer;
      transition: background .2s ease, color .2s ease;
    }
    .cart-item-remove:hover {
      background: #fee2e2;
      color: #b91c1c;
    }

    /* Responsive adjustments */
    @media (max-width: 900px) {
      .cart-row {
        grid-template-columns: 64px 1fr 100px 1fr;
        grid-template-areas:
          "image name name remove"
          "image price qty total";
        row-gap: 10px;
      }
      .cart-item-image { grid-area: image; width: 64px; height: 64px; }
      .cart-item-name { grid-area: name; }
      .cart-item-price { grid-area: price; }
      .cart-item-qty { grid-area: qty; }
      .cart-item-total { grid-area: total; }
      .cart-item-remove { grid-area: remove; justify-self: end; }
    }

    @media (max-width: 560px) {
      body { padding: 18px; }
      .cart-container { border-radius: 12px; }
      #cart-items { padding: 10px 12px 0; gap: 12px; }
      .cart-row { padding: 12px; gap: 12px; }
      .summary { flex-direction: column; gap: 10px; }
      .summary .left, .summary .right { width: 100%; }
    }
  </style>
</head>
<body>

  <h2>My Shopping Cart</h2>
  
  <div class="cart-container">
    <div id="cart-items"></div>
    <div class="summary">
      <div class="left">
        <div><span>Discount </span> <span> = ₹0.00</span></div>
        <div><span>Delivery </span> <span> = ₹0.00</span></div>
      </div>
      <div class="right">
        <div><span>Total = </span> <span id="cart-total"></span></div>
        <div><span></span> <strong id="cart-total-dup"></strong></div>
      </div>
    </div>

    <div class="cart-actions">
      <button class="back-btn" id="history-back-btn">Back</button>
      <button class="checkout-btn" id="checkout-btn">Checkout</button>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div class="modal-overlay" id="confirmation-modal">
    <div class="confirmation-modal">
      <h2>✅ Order Confirmed!</h2>
      <p id="confirmation-message">Your order has been confirmed and will be delivered to <span class="location-highlight" id="delivery-location">your selected location</span>.</p>
      <button onclick="closeConfirmationModal()">Continue Shopping</button>
    </div>
  </div>

<script src="cart.js"></script>
<script>
  // Back navigates to previous page if available, else fallback to homepage
  (function(){
    var backBtn = document.getElementById('history-back-btn');
    if (backBtn) {
      backBtn.addEventListener('click', function(){
        if (document.referrer && document.referrer !== location.href) {
          history.back();
        } else {
          window.location.href = './dualstyle.html';
        }
      });
    }
  })();

  // Mirror total into both fields for your existing layout
  document.addEventListener('DOMContentLoaded', function () {
    var totalEl = document.getElementById('cart-total');
    var dupEl = document.getElementById('cart-total-dup');
    var observer = new MutationObserver(function () {
      if (totalEl && dupEl) dupEl.textContent = totalEl.textContent;
    });
    if (totalEl) observer.observe(totalEl, { childList: true, characterData: true, subtree: true });

    // Checkout functionality
    var checkoutBtn = document.getElementById('checkout-btn');
    if (checkoutBtn) {
      checkoutBtn.addEventListener('click', function() {
        // Check if cart has items
        var cart = [];
        try {
          var raw = localStorage.getItem('cartItems');
          if (raw) {
            cart = JSON.parse(raw);
          }
        } catch(e) {
          cart = [];
        }

        if (cart.length === 0) {
          alert('Your cart is empty. Please add items before checkout.');
          return;
        }

        // Get location from localStorage
        var userCity = localStorage.getItem('userCity');
        var userPincode = localStorage.getItem('userPincode');

        // Check if city is selected
        if (!userCity || userCity === 'SELECT LOCATION' || userCity.trim() === '') {
          alert('Please select your delivery city before placing the order. Click on "SELECT LOCATION" to choose your city.');
          return;
        }

        // Validate city existence if pincode is available
        if (userPincode && userPincode.trim() !== '') {
          validateCityAndProceedCheckout(userCity, userPincode);
        } else {
          // If no pincode, just validate city name format
          if (isValidCityName(userCity)) {
            proceedWithCheckout(userCity);
          } else {
            alert('Please enter a valid city name. City names should only contain letters and spaces.');
            return;
          }
        }
      });
    }

    // Function to validate city name format
    function isValidCityName(cityName) {
      // Check if city name contains only letters, spaces, and common punctuation
      var cityPattern = /^[a-zA-Z\s\-\.\']+$/;
      return cityPattern.test(cityName) && cityName.length >= 2;
    }

    // Function to validate city existence using postal API
    function validateCityAndProceedCheckout(cityName, pincode) {
      // Show loading state
      var checkoutBtn = document.getElementById('checkout-btn');
      var originalText = checkoutBtn.textContent;
      checkoutBtn.textContent = 'Validating...';
      checkoutBtn.disabled = true;

      // Validate using India Post API
      fetch(`https://api.postalpincode.in/pincode/${pincode}`)
        .then(response => response.json())
        .then(data => {
          checkoutBtn.textContent = originalText;
          checkoutBtn.disabled = false;

          if (data && data[0] && data[0].Status === 'Success') {
            var postOffices = data[0].PostOffice;
            var cityExists = false;
            
            // Check if the entered city matches any of the postal data
            for (var i = 0; i < postOffices.length; i++) {
              var office = postOffices[i];
              if (office.District && office.District.toLowerCase() === cityName.toLowerCase() ||
                  office.Name && office.Name.toLowerCase() === cityName.toLowerCase() ||
                  office.Block && office.Block.toLowerCase() === cityName.toLowerCase()) {
                cityExists = true;
                break;
              }
            }

            if (cityExists) {
              proceedWithCheckout(cityName);
            } else {
              alert(`The city "${cityName}" does not match the postal code ${pincode}. Please verify your city name or update your location.`);
            }
          } else {
            alert('Unable to validate the city. Please check your internet connection and try again, or verify your location details.');
          }
        })
        .catch(error => {
          checkoutBtn.textContent = originalText;
          checkoutBtn.disabled = false;
          console.error('City validation error:', error);
          
          // If API fails, proceed with basic validation
          if (isValidCityName(cityName)) {
            proceedWithCheckout(cityName);
          } else {
            alert('Unable to validate city. Please ensure you have entered a valid city name.');
          }
        });
    }

    // Function to proceed with checkout after validation
    function proceedWithCheckout(cityName) {
      // Update confirmation message
      var locationSpan = document.getElementById('delivery-location');
      if (locationSpan) {
        locationSpan.textContent = cityName;
      }

      // Show confirmation modal
      var modal = document.getElementById('confirmation-modal');
      if (modal) {
        modal.style.display = 'flex';
      }

      // Clear the cart
      localStorage.removeItem('cartItems');

      // Update cart UI immediately
      var itemsContainer = document.getElementById('cart-items');
      var totalEl = document.getElementById('cart-total');
      var dupEl = document.getElementById('cart-total-dup');
      
      if (itemsContainer) {
        itemsContainer.innerHTML = '<div class="cart-empty">Your cart is empty.</div>';
      }
      if (totalEl) {
        totalEl.textContent = '₹0';
      }
      if (dupEl) {
        dupEl.textContent = '₹0';
      }
    }
  });

  // Close confirmation modal
  function closeConfirmationModal() {
    var modal = document.getElementById('confirmation-modal');
    if (modal) {
      modal.style.display = 'none';
    }
    // Redirect to homepage
    window.location.href = './dualstyle.html';
  }
</script>
</body>
</html>